name: Auto Fix CI Failures (MVP)

on:
  workflow_run:
    workflows: [CI, Test Chef Chopsky Agent]
    types: [completed]

jobs:
  analyze-and-fix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm run install:all
      
      - name: Configure Git
        run: |
          git config user.name "Cursor Auto-Fix Bot"
          git config user.email "cursor-autofix@noreply.github.com"
      
      - name: Extract failure context
        id: context
        run: |
          echo "WORKFLOW_RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "WORKFLOW_RUN_URL=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "HEAD_SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
      
      - name: Get PR information
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get PR number from the head branch
          PR_NUMBER=$(gh pr list --head "${{ steps.context.outputs.HEAD_BRANCH }}" --json number --jq '.[0].number' || echo "")
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for branch ${{ steps.context.outputs.HEAD_BRANCH }}"
            exit 1
          fi
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER"
      
      - name: Create fix branch
        id: fix-branch
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.PR_NUMBER }}"
          FIX_BRANCH="ci-fix-${PR_NUMBER}"
          
          # Check if fix branch already exists
          if git show-ref --verify --quiet refs/remotes/origin/$FIX_BRANCH; then
            echo "Fix branch $FIX_BRANCH already exists, updating..."
            git checkout $FIX_BRANCH
            git pull origin $FIX_BRANCH
          else
            echo "Creating new fix branch $FIX_BRANCH"
            git checkout -b $FIX_BRANCH
          fi
          
          echo "FIX_BRANCH=$FIX_BRANCH" >> $GITHUB_OUTPUT
      
      - name: Install Cursor CLI
        run: |
          echo "Installing Cursor CLI..."
          curl -fsSL https://cursor.com/install | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH
          
          # Verify installation
          cursor-agent --version || echo "Cursor CLI installation may need additional setup"
      
      - name: Analyze CI failure with Cursor CLI
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          WORKFLOW_RUN_URL: ${{ steps.context.outputs.WORKFLOW_RUN_URL }}
          PR_NUMBER: ${{ steps.pr-info.outputs.PR_NUMBER }}
          FIX_BRANCH: ${{ steps.fix-branch.outputs.FIX_BRANCH }}
          HEAD_BRANCH: ${{ steps.context.outputs.HEAD_BRANCH }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "üîç Analyzing CI failure with Cursor CLI..."
          echo "Workflow Run: ${{ steps.context.outputs.WORKFLOW_RUN_URL }}"
          echo "PR Number: ${{ steps.pr-info.outputs.PR_NUMBER }}"
          echo "Fix Branch: ${{ steps.fix-branch.outputs.FIX_BRANCH }}"
          
          # Run the enhanced Cursor CLI analysis
          node scripts/cursor-analysis.js
      
      # - name: Apply basic fixes
      #   run: |
      #     echo "üîß Applying basic fixes..."
      #     
      #     # Try common fixes with timeout protection
      #     echo "Running lint fix..."
      #     timeout 300 npm run lint || echo "Lint check completed"
      #     
      #     echo "Running type-check..."
      #     timeout 300 npm run type-check || echo "Type-check completed with some issues"
      #     
      #     echo "Running tests..."
      #     timeout 600 npm run test || echo "Tests completed with some failures"
      #     
      #     echo "Running build..."
      #     timeout 600 npm run build || echo "Build completed with some issues"
      #     
      #     # Check if any files were modified
      #     if [ -n "$(git status --porcelain)" ]; then
      #       echo "‚úÖ Files modified by auto-fix"
      #       git add .
      #       git commit -m "Auto-fix CI failure: ${{ steps.context.outputs.WORKFLOW_RUN_ID }}"
      #     else
      #       echo "‚ÑπÔ∏è No files modified by auto-fix"
      #     fi
      # 
      # - name: Test the fix
      #   run: |
      #     echo "üß™ Testing the fix..."
      #     
      #     # Run basic tests to see if fix worked
      #     npm run test || echo "Tests still failing"
      #     npm run lint || echo "Linting still failing"
      #     npm run type-check || echo "Type checking still failing"
      
      - name: Push fix branch
        run: |
          FIX_BRANCH="${{ steps.fix-branch.outputs.FIX_BRANCH }}"
          
          # Add and commit the analysis file
          git add AUTO_FIX_ANALYSIS.md cursor-prompt.txt || echo "No new files to add"
          git commit -m "Add CI failure analysis: ${{ steps.context.outputs.WORKFLOW_RUN_ID }}" || echo "No changes to commit"
          
          # Pull any remote changes first, then push
          git pull origin $FIX_BRANCH --rebase || echo "No remote changes to pull"
          
          # Push the fix branch
          if git push origin $FIX_BRANCH; then
            echo "‚úÖ Fix branch pushed successfully"
          else
            echo "‚ùå Failed to push fix branch"
            exit 1
          fi
      
      - name: Create PR comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.PR_NUMBER }}"
          FIX_BRANCH="${{ steps.fix-branch.outputs.FIX_BRANCH }}"
          WORKFLOW_URL="${{ steps.context.outputs.WORKFLOW_RUN_URL }}"
          
          # Create PR comment with analysis
          gh pr comment "$PR_NUMBER" --body "
          ü§ñ **CI Failure Analysis Complete**
          
          I've analyzed the CI failure and generated a comprehensive analysis report.
          
          **Fix Branch**: \`$FIX_BRANCH\`
          **Workflow**: $WORKFLOW_URL
          **Analysis Report**: See \`AUTO_FIX_ANALYSIS.md\` in the fix branch
          
          [Create PR from fix branch ‚Üí](https://github.com/${{ github.repository }}/compare/$FIX_BRANCH)
          
          ## What's included:
          - ‚úÖ Failed GitHub checks analysis
          - ‚úÖ Detailed error logs and context
          - ‚úÖ Environment and repository information
          - ‚úÖ Copy-paste ready Cursor prompt for interactive debugging
          
          **Next Step**: Use the copy-paste prompt in the analysis file to start an interactive Cursor session for fixing the issues.
          "
