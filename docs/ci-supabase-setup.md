# CI Supabase Configuration

## Overview

The CI workflow uses **local Supabase CLI** (Docker-based) with **dynamically generated credentials** instead of requiring separate hosted Supabase projects for testing.

## Architecture

- **CI Tests**: Local Supabase CLI → `http://127.0.0.1:54321` (Docker containers)
- **Staging Tests**: Hosted Supabase → `chef-chopsky-staging` project
- **Production**: Hosted Supabase → `chef-chopsky-production` project

## Required GitHub Secrets

### For CI (Local Supabase CLI)
**None required!** The Supabase CLI generates credentials dynamically.

### For Staging Tests
- `STAGING_SUPABASE_URL`: Staging project URL
- `STAGING_SUPABASE_PUBLISHABLE_KEY`: Staging publishable key
- `STAGING_SUPABASE_SECRET_KEY`: Staging secret key

## How CI Works

### Dynamic Credential Generation
```bash
# 1. Start local Supabase
cd frontend && supabase start

# 2. Extract credentials dynamically
supabase status -o env > /tmp/supabase.env

# 3. Set environment variables
export $(cat /tmp/supabase.env | xargs)
echo "NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL" >> $GITHUB_ENV
echo "NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=$NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY" >> $GITHUB_ENV
echo "SUPABASE_SECRET_KEY=$SUPABASE_SECRET_KEY" >> $GITHUB_ENV
```

## Benefits

✅ **No Additional Supabase Projects**: Uses Docker containers  
✅ **No GitHub Secrets Required**: Credentials generated dynamically  
✅ **Cost Effective**: No hosted Supabase costs for CI  
✅ **Fast & Reliable**: Local database starts in seconds  
✅ **Isolated**: Each CI run gets a fresh database  
✅ **Consistent**: Same setup as local development  

## CI Workflow

1. **Install Supabase CLI**: `npm install -g supabase@latest`
2. **Start Local Supabase**: `cd frontend && supabase start`
3. **Extract Credentials**: `supabase status -o env`
4. **Set Environment Variables**: Dynamically from Supabase output
5. **Run Tests**: Integration and E2E tests use real database
6. **Cleanup**: `cd frontend && supabase stop`

## Environment Variables

```yaml
# CI dynamically sets these after starting Supabase CLI
NEXT_PUBLIC_SUPABASE_URL: http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: <generated by CLI>
SUPABASE_SECRET_KEY: <generated by CLI>
```

## Migration Strategy

- **Local Development**: Supabase CLI with migrations
- **CI Testing**: Same Supabase CLI setup with dynamic credentials
- **Staging Deployment**: Migrations applied to hosted staging
- **Production Deployment**: Migrations applied to hosted production

This ensures all environments use the same database schema and migrations.
